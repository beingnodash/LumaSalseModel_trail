"""
用户指南页面 - 集成完整的用户指南文档
User Guide Page - Integrated comprehensive user guide
"""

import streamlit as st

# 设置页面配置
st.set_page_config(
    page_title="用户指南 - Luma高校销售与收益分析模型",
    page_icon="📖",
    layout="wide",
    initial_sidebar_state="expanded"
)

# 页面标题
st.title("📖 用户指南")
st.markdown("### *Luma高校销售与收益分析模型完整使用指南*")

# 添加导航目录
st.markdown("""
<div style="background-color: #f0f2f6; padding: 20px; border-radius: 10px; margin: 20px 0;">
<h4>📚 快速导航</h4>
<p>本指南将帮助您了解如何有效使用这个企业级财务分析工具，即使您没有深厚的财务背景，也能轻松上手并从中获益。</p>

<div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-top: 15px;">
<div>
<h6>🚀 快速入门</h6>
<ul style="font-size: 0.9em;">
<li><a href="#1-模型简介">模型简介</a></li>
<li><a href="#2-快速上手">快速上手</a></li>
<li><a href="#3-核心功能详解">核心功能详解</a></li>
</ul>
</div>

<div>
<h6>⚙️ 配置与分析</h6>
<ul style="font-size: 0.9em;">
<li><a href="#4-参数配置指南">参数配置指南</a></li>
<li><a href="#5-结果解读与分析">结果解读与分析</a></li>
<li><a href="#6-高级功能使用">高级功能使用</a></li>
</ul>
</div>

<div>
<h6>🔧 支持与优化</h6>
<ul style="font-size: 0.9em;">
<li><a href="#7-常见问题与解决方案">常见问题与解决方案</a></li>
<li><a href="#总结">总结</a></li>
</ul>
</div>
</div>
</div>
""", unsafe_allow_html=True)

# 创建侧边栏导航
st.sidebar.markdown("## 📋 章节导航")
chapters = [
    ("🎯 模型简介", "1-模型简介"),
    ("🚀 快速上手", "2-快速上手"),
    ("💡 核心功能详解", "3-核心功能详解"),
    ("⚙️ 参数配置指南", "4-参数配置指南"),
    ("📊 结果解读与分析", "5-结果解读与分析"),
    ("🔬 高级功能使用", "6-高级功能使用"),
    ("❓ 常见问题", "7-常见问题与解决方案"),
]

selected_chapter = st.sidebar.radio(
    "选择章节:",
    chapters,
    format_func=lambda x: x[0]
)

# 根据选择显示对应章节，或显示完整文档
if st.sidebar.checkbox("显示完整指南", value=True):
    # 显示完整的用户指南
    st.markdown("""
---

# Luma高校销售与收益分析模型 - 用户指南

欢迎使用Luma高校销售与收益分析模型！本指南将帮助您了解如何有效使用这个企业级财务分析工具，即使您没有深厚的财务背景，也能轻松上手并从中获益。

## 1. 模型简介

Luma高校销售与收益分析模型是一个强大的AI驱动财务决策支持工具，专为高校市场业务设计。基于简化的7大类参数架构，它能够精确预测不同策略下的财务表现，并提供智能的业务洞察。

### 🎯 核心价值

**战略决策支持**：
- **收益预测**：精确预测未来3-5年的财务表现
- **策略对比**：量化不同商业策略的收益差异
- **风险评估**：识别关键风险因子和潜在增长机会
- **参数优化**：自动寻找最佳参数组合

**业务模式覆盖**：
- **模式A**：高校付费 + 学生免费（适合教育预算充足的重点高校）
- **模式B**：高校付费 + 学生次卡付费 + 收入分成（平衡的合作模式）
- **模式C**：高校免费 + 学生次卡付费 + Luma获得100%学生收入（适合预算受限但学生付费能力强的院校）

**智能分析能力**：
- **AI驱动洞察**：基于参数影响的智能业务建议
- **多维度分析**：收入构成、增长趋势、客户价值等全方位分析
- **现实约束优化**：考虑价格弹性、竞争因素的真实优化

## 2. 快速上手

### 启动应用

#### 环境准备

```bash
# 方法1：使用Poetry（推荐）
cd LumaSalseModel_trail
poetry install
poetry run streamlit run lumasalsemodel_trail/streamlit_app/app.py

# 方法2：直接安装依赖
pip install streamlit plotly pandas numpy matplotlib seaborn scikit-optimize deap
streamlit run lumasalsemodel_trail/streamlit_app/app.py
```

#### 访问应用
应用启动后会自动在浏览器中打开，地址通常是 `http://localhost:8501`

### 界面概览

应用采用清晰的多页面架构，通过侧边栏导航：

#### 🏠 主应用页面
**四大功能标签页**：
- **🎯 参数配置**：基于7大类参数的直观配置界面
- **📊 模型运行**：一键财务建模，实时结果展示
- **📈 结果分析**：多维度可视化分析和数据洞察
- **🔍 深度洞察**：智能业务摘要和关键指标分析

#### 📊 增强敏感性分析
**三种分析模式**：
- **单参数分析**：深入分析单个参数的影响曲线
- **多参数对比**：并行分析多个参数的影响效果  
- **重要性排序**：智能识别最具影响力的关键因子

#### 🚀 智能策略优化
**四大核心功能**：
- **智能优化配置**：参数选择和算法推荐
- **优化监控与诊断**：实时收敛监控和参数分析
- **鲁棒性分析**：稳定性测试和风险评估
- **结果对比分析**：多算法性能对比

### 基本工作流程

```
1. 参数配置 → 2. 模型运行 → 3. 结果分析 → 4. 深度洞察
     ↓
5. 敏感性分析（可选）→ 6. 策略优化（可选）→ 7. 结果导出
```

## 3. 核心功能详解

### 主应用：参数配置与财务建模

#### 参数配置标签页

**配置界面特色**：
- **7大类参数结构**：逻辑清晰，配置简单
- **实时验证**：自动检查参数合理性和一致性
- **智能默认值**：基于业务逻辑的合理默认设置
- **配置摘要**：清晰展示当前参数配置概览

**操作步骤**：
1. **基础参数**：设置分析周期（建议至少8个半年）
2. **价格参数**：配置学生端和高校端的定价策略
3. **市场规模**：设定客户增长目标和学校规模
4. **市场分布**：调整A/B/C三种商业模式的分布比例
5. **学生细分**：设置单次付费vs次卡付费的用户分布
6. **续费率**：配置客户留存和复购率参数
7. **分成比例**：设定模式B的收入分配策略（模式C为Luma 100%）

#### 模型运行标签页

**核心功能**：
- **一键建模**：点击运行即可获得完整财务预测
- **实时反馈**：进度条和状态提示的即时更新
- **关键指标**：核心业务指标的清晰展示
- **错误处理**：友好的错误提示和恢复建议

**主要输出指标**：
- **Luma总收入**：最重要的财务指标
- **收入构成**：高校付费 vs 学生分成收入
- **客户增长**：活跃高校数和付费学生数
- **业务效率**：平均每校收入、每生收入等

#### 结果分析标签页

**可视化系统**：
- **收入趋势图**：时间序列的收入发展轨迹
- **收入构成分析**：不同来源收入的比例和变化
- **业务指标仪表板**：关键KPI的2x2矩阵展示
- **客户增长分析**：高校和学生数量的增长趋势

**交互功能**：
- **鼠标悬停**：查看具体数值和详细信息
- **图例控制**：显示/隐藏特定数据系列
- **缩放平移**：图表的交互式探索
- **中文表格**：支持中文列名的直观数据显示
- **双语导出**：支持中文列名和英文列名两种CSV格式下载

#### 深度洞察标签页

**智能分析**：
- **财务摘要**：关键财务指标的自动汇总
- **增长分析**：收入增长率和趋势评估
- **模式效果**：不同商业模式的表现对比
- **策略建议**：基于分析结果的业务建议

### 增强敏感性分析：理解关键影响因子

#### 单参数敏感性分析

**适用场景**：深入理解单个参数对业务的影响

**操作流程**：
1. **参数选择**：从20+个关键参数中选择目标参数
2. **变化范围**：设定参数的变化范围（如±20%）
3. **分析点数**：选择分析的精度（点数越多越精确）
4. **运行分析**：查看参数变化对目标指标的影响曲线

**结果解读**：
- **影响方向**：正相关还是负相关
- **影响强度**：曲线的陡峭程度
- **敏感区间**：影响最显著的参数范围
- **业务建议**：基于分析的策略建议

#### 多参数对比分析

**适用场景**：比较多个参数的相对影响力

**操作技巧**：
- **参数数量**：建议同时分析3-5个相关参数
- **范围设置**：确保各参数的变化范围具有可比性
- **分类对比**：可以按价格类、市场类、续费类等分组分析

**对比维度**：
- **影响幅度**：各参数的最大影响范围
- **敏感性排序**：影响力的相对排名
- **协同效应**：参数间的相互作用

#### 参数重要性排序

**智能评估**：系统自动评估所有参数的重要性

**评估指标**：
- **变化幅度**：参数变化导致的结果变化范围
- **变异系数**：结果分布的稳定性
- **相关系数**：与目标指标的线性相关性
- **综合得分**：多维度加权的最终排序

**应用价值**：
- **优先级排序**：识别最值得关注的参数
- **资源配置**：将注意力集中在关键影响因子上
- **风险管理**：识别高风险参数并制定应对措施

### 智能策略优化：寻找最佳方案

#### 智能优化配置

**参数预设系统**：
- **价格优化**：学生端定价策略优化
- **分成策略**：收入分配比例优化
- **市场策略**：客户获取和留存优化
- **综合策略**：多维度参数的综合优化
- **高校定价策略**：高校端定价模型优化

**算法智能推荐**：
- **问题特征分析**：参数维度、搜索空间大小
- **算法适配评估**：基于预算、精度、效率的推荐
- **参数建议**：针对选定算法的最佳参数设置

**现实约束配置**：
- **价格弹性约束**：考虑价格变化对需求的影响
- **竞争因素**：高分成比例对高校接受度的影响
- **市场容量限制**：获客成本的边际递增效应

#### 优化监控与诊断

**实时监控系统**：
- **收敛过程**：优化迭代的实时可视化
- **早停建议**：智能的早停决策和建议
- **性能追踪**：详细的迭代历史记录

**参数合理性分析**：
- **约束验证**：检查参数是否满足业务约束
- **合理范围评估**：基于行业标准的参数评估
- **风险提示**：识别可能的风险参数组合

#### 鲁棒性分析

**稳定性测试**：
- **Monte Carlo模拟**：参数不确定性建模
- **扰动测试**：小幅参数变化的影响评估
- **置信区间**：结果的统计置信区间

**风险评估**：
- **低风险**：结果稳定，参数变化影响小
- **中风险**：部分参数敏感，需要谨慎实施
- **高风险**：结果不稳定，建议进一步分析

## 4. 参数配置指南

### 7大类参数详解

#### 1. 基础参数
**核心设置**：
- `total_half_years`：分析周期数（半年）
- **建议值**：1-16个半年（对应0.5-8年），确保覆盖完整业务周期
- **推荐设置**：至少8个半年，以观察完整的3年服务周期和续约情况

#### 2. 价格参数

**学生端定价**（次卡模式）：
- `price_single_use`：单次付费价格（5-20元）
- `price_5_times_card`：5次卡价格（20-60元）
- `price_10_times_card`：10次卡价格（30-80元）
- `price_20_times_card`：20次卡价格（50-120元）

**高校端定价**：
- `mode_a_price`：模式A价格（20-100万元/3年）
- `mode_b_price`：模式B价格（20-100万元/3年）
- `mode_c_price`：模式C价格（固定为0元）

**次卡定价策略建议**：
- **阶梯定价**：次卡购买次数越多，单次成本越低，鼓励批量购买
- **价值包装**：突出次卡相比单次付费的优势和便利性
- **心理定价**：考虑学生的支付心理和承受能力
- **竞争分析**：参考市场上类似次卡产品的价格水平

#### 3. 市场规模
- `new_clients_per_half_year`：每半年新客户数（1-15家）
- `avg_students_per_uni`：平均学校规模（5000-30000人）

**设置要点**：
- **增长目标**：基于市场容量和团队能力设定realistic targets
- **区域差异**：考虑不同地区高校的规模差异
- **分阶段目标**：可以设置初期保守、后期积极的增长策略

#### 4. 市场分布

**商业模式分布**：
- `mode_a_ratio`：模式A占比（0.1-0.7）
- `mode_b_ratio`：模式B占比（0.1-0.7）
- `mode_c_ratio`：模式C占比（0.1-0.7）

**付费转化**：
- `student_paid_conversion_rate_bc`：B/C模式学生付费转化率（5%-30%）

**分布策略**：
- **模式A**：适合预算充足的985/211高校，学生全免费使用
- **模式B**：主流合作模式，高校部分付费+学生次卡付费+收入分成
- **模式C**：适合预算紧张但学生付费能力强的高校，Luma获得100%学生收入

#### 5. 学生市场细分分布

**付费方式分布**：
- `single_use_ratio`：单次付费比例（0.2-0.8）
- `card_type_distribution`：次卡类型分布

**次卡类型分布**（在次卡用户中）：
- `5_times`：5次卡占比（0.3-0.7）
- `10_times`：10次卡占比（0.2-0.5）
- `20_times`：20次卡占比（0.1-0.3）

**次卡策略**：
- **单次付费**：吸引试用用户，零门槛体验
- **5次卡**：轻度使用用户的主流选择
- **10次卡**：中度使用用户，平衡价格和使用量
- **20次卡**：重度使用用户，最佳性价比

#### 6. 续费率与复购率参数

**高校续费**：
- `university_3year_renewal`：高校3年续约率（50%-95%）

**学生复购**：
- `student_single_use_repurchase`：单次付费复购率（40%-90%）
- `student_5_times_card_repurchase`：5次卡复购率（40%-90%）
- `student_10_times_card_repurchase`：10次卡复购率（40%-90%）
- `student_20_times_card_repurchase`：20次卡复购率（40%-90%）

**复购策略**：
- **高校续费**：重点关注服务质量和ROI证明
- **学生复购**：产品体验和性价比是关键
- **差异化复购率**：不同次卡类型的用户粘性差异化设置
- **时间分布**：新购在当期，复购从下期开始的准确时间模型

#### 7. 分成比例
- `luma_share_from_student_mode_b`：模式B学生收入分成比例（20%-80%）
- 模式C：Luma获得100%学生收入，高校不参与分成

**分成策略**：
- **模式B分成**：平衡Luma收益和高校积极性的合理分成
- **模式C独享**：Luma获得全部学生收入，降低高校合作门槛
- **价值证明**：分成比例需要与提供的价值和服务相匹配
- **差异化策略**：不同模式的分成策略体现不同的合作深度

### 商业模式选择

#### 模式A：高校全额付费
**适用场景**：
- 985/211等预算充足的重点高校
- 对学生免费使用有强烈需求的院校
- 希望获得完整功能授权的合作方

**优劣分析**：
- ✅ 收入稳定可预测
- ✅ 学生零门槛，使用率高
- ❌ 高校决策周期长
- ❌ 单一收入来源风险

#### 模式B：混合付费模式
**适用场景**：
- 一般本科院校和优质专科院校
- 预算适中，愿意尝试新模式的高校
- 学生有一定次卡付费能力的院校

**优劣分析**：
- ✅ 收入来源多样化（高校固定费+学生次卡分成）
- ✅ 风险分散，灵活性强
- ✅ 学生次卡付费能力验证
- ✅ 高校与Luma利益共享，合作稳定
- ❌ 运营复杂度较高

#### 模式C：学生次卡付费为主
**适用场景**：
- 预算紧张的地方院校
- 学生次卡付费意愿和能力较强的专业院校
- 愿意尝试纯市场化模式的合作方

**优劣分析**：
- ✅ 高校门槛低，容易快速扩张
- ✅ Luma获得100%学生收入，收益最大化
- ✅ 次卡模式降低学生单次付费压力
- ❌ 收入完全依赖学生付费，不确定性大
- ❌ 对产品质量和用户体验要求极高

### 参数设置最佳实践

#### 数据驱动的参数设置

**历史数据分析**：
- 收集类似产品或试点项目的历史数据
- 分析不同参数设置下的实际表现
- 识别影响关键指标的主要因子

**市场调研**：
- 调研目标高校的预算情况和付费意愿
- 了解学生的付费习惯和价格敏感度
- 分析竞品的定价策略和市场表现

**A/B测试**：
- 在不同地区或高校类型中测试不同参数
- 验证理论假设和模型预测的准确性
- 持续优化参数设置

#### 场景化分析方法

**乐观场景**：
- 较高的客户增长率和付费转化率
- 较低的客户流失率
- 适中偏高的定价策略

**基准场景**：
- 基于市场平均水平的参数设置
- 平衡的风险和收益预期
- 符合行业标准的运营指标

**保守场景**：
- 较低的增长预期和转化率
- 较高的流失率和价格敏感度
- 稳健的定价和分成策略

**压力测试**：
- 极端不利条件下的业务表现
- 关键参数恶化时的风险承受能力
- 业务连续性和应急预案

## 5. 结果解读与分析

### 关键财务指标

#### 核心收入指标

**Luma总收入（luma_revenue_total）**：
- **定义**：Luma在分析期内的总收入
- **构成**：高校付费 + 学生分成收入
- **重要性**：最核心的财务表现指标
- **分析要点**：关注增长趋势、波动性、构成变化

**收入构成分析**：
- `luma_revenue_from_uni`：来自高校的固定收入
- `luma_revenue_from_student_share`：来自学生次卡付费的分成收入
- `student_revenue_single_use`：学生单次付费收入
- `student_revenue_card`：学生次卡收入
- **分析价值**：了解收入稳定性和增长驱动力，次卡vs单次付费贡献

**单位经济效益**：
- `avg_revenue_per_uni`：平均每校收入
- `avg_revenue_per_paying_student`：平均每付费学生收入
- **优化方向**：提升单位客户价值

#### 业务运营指标

**客户规模指标**：
- `active_universities`：活跃高校数量
- `total_paying_students`：总付费学生数
- **分析要点**：增长速度、留存率、饱和度

**市场渗透指标**：
- 高校市场占有率：active_universities / 目标市场总量
- 学生付费渗透率：paying_students / total_students
- **战略价值**：评估市场拓展潜力

**客户质量指标**：
- 高校续约率：反映客户满意度和粘性
- 学生续费率：反映产品价值和用户体验
- ARPU增长率：反映客户价值提升

### 可视化图表解读

#### 收入趋势分析

**趋势图解读要点**：
- **增长模式**：线性增长、指数增长、还是阶段性增长
- **周期性**：是否存在季节性或周期性波动
- **转折点**：增长加速或减缓的关键时间点
- **稳定性**：收入流的波动性和可预测性

**构成变化分析**：
- **收入来源结构**：固定收入vs分成收入的比例变化
- **商业模式效果**：不同模式对总收入的贡献度
- **客户类型分布**：不同类型客户的价值贡献

#### 业务指标仪表板

**KPI监控面板**：
- **实时监控**：关键指标的当前状态
- **目标对比**：实际表现vs预期目标
- **趋势预警**：指标异常变化的预警
- **钻取分析**：从汇总到明细的数据钻取

**相关性分析**：
- **指标关联**：不同KPI之间的相互关系
- **领先指标**：能够预测未来表现的关键指标
- **滞后指标**：反映历史表现的结果指标

## 6. 高级功能使用

### 敏感性分析技巧

#### 单参数深度分析

**选择策略**：
- **价格类参数**：重点关注定价对收入的影响
- **市场类参数**：分析市场拓展速度的影响
- **留存类参数**：评估客户留存的重要性

**分析范围设定**：
- **合理区间**：基于市场现实的参数变化范围
- **敏感性测试**：从小幅到大幅变化的渐进分析
- **临界值探索**：寻找参数影响的临界点

**结果应用**：
- **风险评估**：了解参数变化的风险影响
- **机会识别**：发现参数优化的机会点
- **策略制定**：基于敏感性分析制定业务策略

#### 多参数交互分析

**参数组合策略**：
- **相关参数**：选择业务逻辑相关的参数组合
- **对比分析**：比较不同参数的相对重要性
- **协同效应**：分析参数间的相互作用

**交互效应探索**：
- **正协同**：参数协同提升业务表现
- **负协同**：参数冲突导致效果抵消
- **替代效应**：不同参数实现相似业务目标

### 策略优化指南

#### 优化目标设定

**单目标优化**：
- **收入最大化**：追求最高的总收入
- **利润最大化**：考虑成本后的利润优化
- **客户价值最大化**：focus on long-term customer value

**多目标平衡**：
- **收入与风险平衡**：在收入增长和风险控制间平衡
- **短期与长期平衡**：平衡即期收入和长期价值
- **增长与质量平衡**：在快速增长和质量控制间权衡

#### 算法选择策略

**网格搜索**：
- **适用场景**：参数维度较少（1-3个），需要全面搜索
- **优势**：结果精确，不会遗漏最优解
- **劣势**：计算量大，不适合高维问题

**贝叶斯优化**：
- **适用场景**：参数维度中等（3-8个），追求效率
- **优势**：智能搜索，效率高
- **劣势**：可能错过全局最优解

**遗传算法**：
- **适用场景**：参数维度较高（5+个），复杂约束
- **优势**：适应性强，能处理复杂问题
- **劣势**：结果随机性，需要多次运行

## 7. 常见问题与解决方案

### 技术问题

#### 应用启动问题

**问题：应用无法启动**
```bash
# 解决方案
# 1. 检查Python版本（需要3.8+）
python --version

# 2. 重新安装依赖
pip install --upgrade streamlit plotly pandas numpy

# 3. 清除缓存
streamlit cache clear

# 4. 使用详细模式启动
streamlit run app.py --logger.level=debug
```

**问题：依赖包冲突**
```bash
# 解决方案
# 1. 创建新的虚拟环境
python -m venv luma_env
source luma_env/bin/activate  # Linux/Mac
# 或
luma_env\\Scripts\\activate  # Windows

# 2. 使用Poetry管理依赖
poetry install
poetry shell
```

#### 性能问题

**问题：模型运行缓慢**

**原因分析**：
- 参数维度过高
- 分析点数设置过多
- 计算机性能限制

**解决方案**：
1. **减少分析维度**：一次分析3-5个参数
2. **优化分析点数**：敏感性分析使用10-20个点
3. **分批次分析**：将大型分析任务分解
4. **算法选择**：使用更高效的贝叶斯优化

### 业务问题

#### 参数设置问题

**问题：不知道如何设置参数**

**解决策略**：
1. **使用默认值开始**：先使用系统默认值运行
2. **参考行业数据**：查找相关行业的标准数据
3. **从小改动开始**：在默认值基础上小幅调整
4. **使用敏感性分析**：了解参数的重要性

**问题：参数设置不现实**

**检查清单**：
- 价格是否符合市场水平
- 增长率是否过于乐观
- 留存率是否符合行业标准
- 分成比例是否合理

**调整建议**：
- 参考竞品定价
- 基于历史数据设定增长目标
- 使用保守的留存率预估
- 考虑合作方的接受度

#### 结果解读问题

**问题：结果与预期差异很大**

**分析步骤**：
1. **检查关键假设**：验证核心业务假设是否合理
2. **分解分析**：将总结果分解为各个组成部分
3. **对比基准**：与行业标准或历史数据对比
4. **敏感性测试**：识别影响结果的关键参数

**问题：不确定结果可信度**

**验证方法**：
1. **鲁棒性测试**：测试参数变化对结果的影响
2. **交叉验证**：使用不同方法验证结果
3. **专家评审**：请业务专家评估结果合理性
4. **分段验证**：将长期预测分解为短期验证

### 最佳实践建议

#### 使用习惯

**有效的工作流程**：
1. **先了解再使用**：仔细阅读用户指南
2. **从简单开始**：先使用基本功能再进阶
3. **多次验证**：重要决策前多次验证结果
4. **记录过程**：记录重要的参数设置和分析结果

**数据管理**：
1. **定期保存**：定期保存重要的分析结果
2. **版本控制**：记录不同版本的参数设置
3. **文档记录**：记录重要分析的背景和结论
4. **团队共享**：与团队成员分享关键发现

#### 团队协作

**角色分工**：
- **业务分析师**：负责参数设置和结果解读
- **财务专家**：验证财务指标和假设
- **产品经理**：提供产品策略和市场信息
- **技术专家**：处理技术问题和系统优化

**协作流程**：
1. **需求明确**：明确分析目标和预期产出
2. **参数共识**：团队对关键参数达成共识
3. **结果评审**：多角度评审分析结果
4. **决策支持**：基于分析结果制定行动计划

---

## 新功能特色

### 次卡模式创新

**次卡定价体系**：
- **4种次卡类型**：单次、5次卡、10次卡、20次卡
- **阶梯定价优势**：购买次数越多，单次成本越低
- **灵活支付模式**：适应不同用户的使用频率和支付能力
- **复购时间建模**：新购当期生效，复购从下期开始的精确时间分布

**业务模型优化**：
- **模式C收益最大化**：Luma获得100%学生收入
- **模式B灵活分成**：可配置的收入分成比例
- **独立复购率**：每种次卡类型独立的复购率设置
- **时间分布算法**：准确的收入时间分布和复购建模

### 中文界面优化

**直观数据展示**：
- **中文列名表格**：所有财务数据表格支持中文列名显示
- **格式化数值**：收入字段显示¥符号和千分位分隔符
- **双语导出功能**：同时支持中文和英文列名的CSV下载

**用户体验提升**：
- **业务术语本土化**：使用符合中国用户习惯的术语
- **数据可读性**：金额和数量的专业格式化显示
- **文档完整性**：全面的中文用户指南和操作说明

---

## 总结

Luma高校销售与收益分析模型是一个功能强大的决策支持工具，本次更新重点加强了次卡模式的业务建模能力和中文用户体验。通过合理使用其各项功能，您可以：

- **精确建模**：基于次卡模式的精确财务预测
- **优化策略**：多种商业模式的对比和优化
- **直观分析**：中文界面的友好数据展示
- **灵活导出**：支持多种格式的数据导出

### 最新特性总结
- ✅ **次卡定价模型**：4种次卡类型的完整定价体系
- ✅ **差异化复购率**：每种次卡独立的复购率设置  
- ✅ **收入分成优化**：模式B/C的差异化分成策略
- ✅ **中文界面**：全面的中文化数据展示
- ✅ **时间分布算法**：精确的收入时间分布建模
- ✅ **敏感性分析**：支持次卡模式的全参数敏感性分析

希望这份详细的用户指南能帮助您更好地使用升级后的模型。如果在使用过程中遇到任何问题，请参考常见问题部分或联系技术支持团队。

**记住**：工具只是辅助，最终的商业决策仍需要结合您的行业经验、市场洞察和战略判断。祝您使用愉快，决策成功！

---

**版本信息**：用户指南 v2.1 | 更新日期：2024年12月 | 对应应用版本：Streamlit App v2.1 (次卡模式)
""")
else:
    # 显示选中的章节内容
    chapter_id = selected_chapter[1]
    
    if chapter_id == "1-模型简介":
        st.markdown("""
        ## 1. 模型简介

        Luma高校销售与收益分析模型是一个强大的AI驱动财务决策支持工具，专为高校市场业务设计。基于简化的7大类参数架构，它能够精确预测不同策略下的财务表现，并提供智能的业务洞察。

        ### 🎯 核心价值

        **战略决策支持**：
        - **收益预测**：精确预测未来3-5年的财务表现
        - **策略对比**：量化不同商业策略的收益差异
        - **风险评估**：识别关键风险因子和潜在增长机会
        - **参数优化**：自动寻找最佳参数组合

        **业务模式覆盖**：
        - **模式A**：高校付费 + 学生免费（适合教育预算充足的重点高校）
        - **模式B**：高校付费 + 学生次卡付费 + 收入分成（平衡的合作模式）
        - **模式C**：高校免费 + 学生次卡付费 + Luma获得100%学生收入（适合预算受限但学生付费能力强的院校）

        **智能分析能力**：
        - **AI驱动洞察**：基于参数影响的智能业务建议
        - **多维度分析**：收入构成、增长趋势、客户价值等全方位分析
        - **现实约束优化**：考虑价格弹性、竞争因素的真实优化
        """)
    
    elif chapter_id == "2-快速上手":
        st.markdown("""
        ## 2. 快速上手

        ### 启动应用

        #### 环境准备

        ```bash
        # 方法1：使用Poetry（推荐）
        cd LumaSalseModel_trail
        poetry install
        poetry run streamlit run lumasalsemodel_trail/streamlit_app/app.py

        # 方法2：直接安装依赖
        pip install streamlit plotly pandas numpy matplotlib seaborn scikit-optimize deap
        streamlit run lumasalsemodel_trail/streamlit_app/app.py
        ```

        #### 访问应用
        应用启动后会自动在浏览器中打开，地址通常是 `http://localhost:8501`

        ### 界面概览

        应用采用清晰的多页面架构，通过侧边栏导航：

        #### 🏠 主应用页面
        **四大功能标签页**：
        - **🎯 参数配置**：基于7大类参数的直观配置界面
        - **📊 模型运行**：一键财务建模，实时结果展示
        - **📈 结果分析**：多维度可视化分析和数据洞察
        - **🔍 深度洞察**：智能业务摘要和关键指标分析

        ### 基本工作流程

        ```
        1. 参数配置 → 2. 模型运行 → 3. 结果分析 → 4. 深度洞察
             ↓
        5. 敏感性分析（可选）→ 6. 策略优化（可选）→ 7. 结果导出
        ```
        """)
    
    # 添加更多章节的条件分支...
    elif chapter_id == "7-常见问题与解决方案":
        st.markdown("""
        ## 7. 常见问题与解决方案

        ### 技术问题

        #### 应用启动问题

        **问题：应用无法启动**
        ```bash
        # 解决方案
        # 1. 检查Python版本（需要3.8+）
        python --version

        # 2. 重新安装依赖
        pip install --upgrade streamlit plotly pandas numpy

        # 3. 清除缓存
        streamlit cache clear

        # 4. 使用详细模式启动
        streamlit run app.py --logger.level=debug
        ```

        **问题：依赖包冲突**
        ```bash
        # 解决方案
        # 1. 创建新的虚拟环境
        python -m venv luma_env
        source luma_env/bin/activate  # Linux/Mac

        # 2. 使用Poetry管理依赖
        poetry install
        poetry shell
        ```

        ### 业务问题

        #### 参数设置问题

        **问题：不知道如何设置参数**

        **解决策略**：
        1. **使用默认值开始**：先使用系统默认值运行
        2. **参考行业数据**：查找相关行业的标准数据
        3. **从小改动开始**：在默认值基础上小幅调整
        4. **使用敏感性分析**：了解参数的重要性

        ### 最佳实践建议

        #### 使用习惯

        **有效的工作流程**：
        1. **先了解再使用**：仔细阅读用户指南
        2. **从简单开始**：先使用基本功能再进阶
        3. **多次验证**：重要决策前多次验证结果
        4. **记录过程**：记录重要的参数设置和分析结果
        """)

# 添加页脚
st.markdown("---")
st.markdown("""
<div style="text-align: center; padding: 20px; background-color: #f8f9fa; border-radius: 10px;">
<h4>🤝 需要帮助？</h4>
<p>如果您在使用过程中遇到任何问题，欢迎：</p>
<ul style="list-style: none; padding: 0;">
<li>📧 联系技术支持团队</li>
<li>💬 在主页面查看应用内帮助</li>
<li>📚 参考项目文档和示例</li>
</ul>
<hr>
<small><strong>Luma高校销售与收益分析模型</strong> | 版本 v2.1 (次卡模式) | © 2024 Luma AI</small>
</div>
""", unsafe_allow_html=True)